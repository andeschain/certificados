<script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const contractAddress = "0x064c8a8d123f03bb671addc55b46e00c43cb9"; 
        // ==========================================

        const abi = [
            "function getLoteData(uint256 _loteId) public view returns (string memory)"
        ];

        let gmapsLink = ""; 

        async function init() {
            try {
                // 1. Obtener ID
                const urlParams = new URLSearchParams(window.location.search);
                let loteId = urlParams.get('id');

                // Si no hay ID, forzamos el 1
                if (!loteId) {
                    console.log("Sin ID, cargando default: 1");
                    loteId = "1";
                }

                // 2. Conectar a Blockchain (Usamos ANKR que es m√°s r√°pido)
                // OJO: Si usaste la red de prueba "Amoy", cambia este link. 
                // Asumo que est√°s en Polygon Mainnet.
                const rpcUrl = "https://rpc.ankr.com/polygon"; 
                
                const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                const contrato = new ethers.Contract(contractAddress, abi, provider);

                // 3. Leer Datos con Timeout (Para que no se quede pegado infinito)
                console.log(`üì° Llamando a Blockchain... ID: ${loteId}`);
                document.querySelector('.animate-pulse').innerText = "Conectando sat√©lite...";

                // Creamos una promesa que falla si tarda m√°s de 8 segundos
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Tiempo de espera agotado. La red Polygon est√° lenta.")), 8000)
                );

                const dataPromise = contrato.getLoteData(loteId);
                
                // Carrera entre la data y el timeout
                const jsonString = await Promise.race([dataPromise, timeout]);

                // 4. Procesar
                if (!jsonString) throw new Error("El contrato devolvi√≥ vac√≠o. ¬øEl ID es correcto?");

                console.log("‚úÖ Datos recibidos:", jsonString);
                const data = JSON.parse(jsonString);
                
                // 5. Mostrar en Pantalla
                document.getElementById('productName').innerText = data.producto;
                document.getElementById('brandName').innerText = data.marca;
                document.getElementById('farmName').innerText = data.origen.predio;
                document.getElementById('locationText').innerText = data.origen.zona;
                document.getElementById('harvestDate').innerText = data.fechas.cosecha;
                document.getElementById('variety').innerText = data.variedad;
                document.getElementById('farmerName').innerText = data.agricultores;
                document.getElementById('contractAddressDisplay').innerText = contractAddress;
                gmapsLink = data.origen.gmaps;

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('certificate').classList.remove('hidden');

            } catch (error) {
                console.error("‚ùå ERROR CR√çTICO:", error);
                
                let msg = error.message;
                if (msg.includes("call revert")) msg = "El ID solicitado no existe en el contrato.";
                if (msg.includes("code=")) msg = "Error de Red/Contrato (Revisa la Address).";

                document.getElementById('loader').innerHTML = `
                    <div class="bg-red-100 text-red-700 p-6 rounded-xl border border-red-300 shadow-lg">
                        <h3 class="font-bold text-xl mb-2"><i class="fas fa-exclamation-triangle"></i> Error de Conexi√≥n</h3>
                        <p class="font-mono text-sm mb-4 bg-white p-2 rounded border border-red-200">${msg}</p>
                        <ul class="text-left text-sm list-disc pl-5 space-y-1">
                            <li>¬øPegaste la Address correcta en el c√≥digo?</li>
                            <li>¬øEst√°s seguro que subiste el ID ${loteId}?</li>
                            <li>Abre la consola (F12) para ver detalles.</li>
                        </ul>
                    </div>`;
            }
        }

        function openMap() {
            if (gmapsLink) window.open(gmapsLink, '_blank');
        }
        
        function copyHash() {
            navigator.clipboard.writeText(contractAddress);
            alert("Copiado!");
        }

        init();
    </script>
