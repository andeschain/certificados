<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificado | AndesChain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #f0fdf4; color: #1a2e05; }
        .box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; width: 100%; margin: 20px auto; text-align: center; }
        .btn { background: #16a34a; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="box">
        <h2 class="text-2xl font-bold mb-2">AndesChain</h2>
        <p id="status" class="text-slate-500 animate-pulse">Conectando...</p>
        
        <div id="dataArea" class="hidden text-left mt-4 space-y-3 border-t pt-4">
            <div>
                <p class="text-xs text-slate-400 uppercase font-bold">Producto</p>
                <p id="prod" class="text-xl font-bold text-green-700">...</p>
            </div>
            <div>
                <p class="text-xs text-slate-400 uppercase font-bold">Ubicación</p>
                <p id="loc">...</p>
            </div>
             <div>
                <p class="text-xs text-slate-400 uppercase font-bold">Agricultor</p>
                <p id="farmer">...</p>
            </div>
            <a id="mapBtn" href="#" target="_blank" class="btn w-full text-center">Ver Mapa Satelital</a>
        </div>
    </div>

    <script>
        // --- ATRAPA ERRORES GLOBALES (Si falla la sintaxis, salta esto) ---
        window.onerror = function(msg, url, line) {
            alert("ERROR DE CÓDIGO:\n" + msg + "\n\nRevisa la línea " + line);
            return true;
        };

        // ==============================================================
        // ⚠️ PEGA TU DIRECCIÓN AQUÍ CON CUIDADO (MANTÉN LAS COMILLAS) ⚠️
        const contractAddress = "0x064c8a8d123f03bb671addc55b46e00c43cb97dd"; 
        // ==============================================================

        const abi = ["function getLoteData(uint256 _loteId) public view returns (string memory)"];

        async function init() {
            const statusEl = document.getElementById('status');
            
            try {
                // 1. Validar que ethers cargó
                if (typeof ethers === 'undefined') throw new Error("No se pudo cargar la librería Ethers. Revisa tu internet.");

                // 2. Obtener ID (Por defecto 1)
                const urlParams = new URLSearchParams(window.location.search);
                let loteId = urlParams.get('id') || "1";

                statusEl.innerText = `Consultando ID ${loteId}...`;

                // 3. Conectar (Probamos Mainnet primero)
                // Usamos un RPC muy estable de Cloudflare
                const provider = new ethers.providers.JsonRpcProvider("https://polygon-bor-rpc.publicnode.com");
                const contrato = new ethers.Contract(contractAddress, abi, provider);

                // 4. Llamada
                const jsonString = await contrato.getLoteData(loteId);
                
                // 5. Mostrar
                const data = JSON.parse(jsonString);
                
                document.getElementById('prod').innerText = data.producto;
                document.getElementById('loc').innerText = data.origen.zona;
                document.getElementById('farmer').innerText = data.agricultores;
                document.getElementById('mapBtn').href = data.origen.gmaps;

                statusEl.innerText = "✅ Verificado en Blockchain";
                statusEl.classList.remove('animate-pulse');
                statusEl.classList.add('text-green-600', 'font-bold');
                document.getElementById('dataArea').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                let msg = error.message;
                
                // Traducción de errores comunes
                if (msg.includes("call revert")) msg = "El ID no existe en el contrato.";
                if (msg.includes("resolver")) msg = "Dirección de contrato inválida.";
                
                statusEl.innerHTML = `<span style='color:red'>❌ Error: ${msg}</span>`;
                alert("Hubo un problema: " + msg);
            }
        }

        init();
    </script>
</body>
</html>
